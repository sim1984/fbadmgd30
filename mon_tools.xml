<?xml version="1.0" encoding="UTF-8"?>
<?xml-model href="http://docbook.org/xml/5.1/rng/docbook.rng" schematypens="http://relaxng.org/ns/structure/1.0"?>
<?xml-model href="http://docbook.org/xml/5.1/sch/docbook.sch" type="application/xml" schematypens="http://purl.oclc.org/dsdl/schematron"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"
    version="5.1" xml:lang="ru" xml:id="mon-tools">
    <info>
        <title>Использование инструментов мониторинга Firebird</title>
    </info>

    <para/>

    <section>
        <title>Использование fb_lock_print</title>
        <para/>
    </section>

    <section xml:id="using-trace">
        <info>
            <title>Использование Firebird Trace API</title>
        </info>
        <section>
            <title>Трассировка. Вводная информация. Зачем это нужно?</title>
            <para>Под трассировкой активности, происходящей в базе под управлением в СУБД Firebird,
                понимается регистрация событий, которые происходят ввиду создания подключений,
                старта и завершения транзакций, явных действий пользователей или некоторых системных
                процессов (на сегодня это процесс sweep).</para>
            <para>Трассировка является незаменимым средством при поиске узких мест приложения,
                оценке ресурсов, затрачиваемых при выполнении запросов, выяснении частоты каких-либо
                действий, а также для целей безопасности (накопление сведений об отклонённых
                попытках регистрации в БД).</para>
            <para>Трассировка показывает статистику в максимально детализированном виде (в отличие
                от статистике доступной например в ISQL). В статистике не учитываются затраты на
                подготовку запроса и передачу данных по сети, что делает её <quote>чище</quote>, чем
                данные, которые показывает ISQL.</para>
            <para>Трассировка оказывает очень незначительное влияние на производительность. Даже при
                интенсивной записи в журнал, речь обычно идет не более чем о 2-3% падения скорости
                выполняемых запросов. Это совершенно не так при выполнении запросов к таблицам
                мониторинга, которые могут привести сильно нагруженную систему в состояние ступора. </para>
            <para>Трассировку можно достаточно гибко настроить. В отличие от мониторинга,
                заставляющего все подключения сбрасывать всю информацию, независимо от того, что
                записано в запросе к mon$-таблицам, трассировка позволяет регистрировать только те
                виды событий, которые нам интересны (например, только ошибки времени выполнения, или
                только факты регистрации пользователей). Кроме того, трассировка позволяет указать
                минимальный порог длительности выполнявшихся запросов, и всё, что длилось меньше,
                регистрироваться не будет. Трассировка позволяет применять фильтры на выражения, по
                принципу включаемости и исключения, что дает возможность отследить только те
                запросы, которые отвечают известным нам шаблонам.</para>
            <para>Трассировка <quote>скрытна</quote>: пользовательское подключение не может
                выяснить, отслеживается ли его активность или нет. Также, у пользователей (даже
                SYSDBA) в Firebird нет средств для предотвращения трассировки их подключений
                администратором. Однако, SYSDBA может увидеть все запущенные пользовательские сессии
                трассировки, и остановить их.</para>
            <para>Наконец, на одной машине можно запускать несколько сеансов трассировки и они будут
                работать независимо, со своими настройками и направлением вывода в разные
                журналы.</para>
            <para>Всё это делает трассировку одним из самых полезных инструментов администратора и
                разработчика БД.</para>
        </section>
        <section>
            <title>Виды отслеживаемой активности. Пользовательский трассировка и системный
                аудит</title>
            <para>Отслеживание активности может происходить двумя способами:<orderedlist>
                    <listitem>
                        <para>Запуском консольного приложения с возможностью его остановки в любое
                            время. Этот вариант работы называется <quote>пользовательский
                                трассировка</quote>. Аварийное завершение работы машины, на которой
                            запущен такая трассировка, либо потеря связи с сервером (при удаленном
                            запуске) приведет к прекращению работы трассировки. Пользовательский
                            трассировка запускается Firebird-утилитами
                                <application>fbsvcmrg</application> или
                                <application>fbtracemgr</application> (вторая является
                                <quote>обёрткой</quote> над первой и предназначена для более
                            краткого формата запуска).</para>
                    </listitem>
                    <listitem>
                        <para>Изменением конфигурации Firebird так, чтобы трассировка стартовал
                            автоматически при каждом запуске СУБД. Такой вариант работы называется
                                <quote>системный аудит</quote>. Отслеживание запускается независимо
                            от пользователей, и его функционирование зависит только от
                            работоспособности машины сервера.</para>
                    </listitem>
                </orderedlist></para>
            <para>Функционально оба варианта одинаковы, но предназначение у них разное.</para>
            <para>Пользовательский трассировка требуется чаще. Она позволяет быстро запустить
                трассировку, дать ей поработать и остановить её для проведения анализа и принятия
                решений. Обычно анализ журнала трассировки занимает не более одного дня.</para>
            <para>Системный аудит предназначен для "сквозной регистрации" всех интересующих событий
                и, как правило, он запускается на длительный срок. Системный аудит нельзя остановить
                иначе, кроме как отключив всех пользователей от БД. Возможное применение системного
                аудита — непрерывное отслеживание попыток регистрации путем подбора паролей, либо
                отслеживание активности, которая приводит к возбуждению каких-то заранее известных
                исключений в режиме выполнения.</para>
            <para>Существует также отличие в реализации пользовательского трассировки и системного
                аудита, которое надо учитывать. Процесс записи журнала пользовательской трассировки
                — это асинхронный процесс. Если диск не успевает справиться с большим потоком
                информации от пользовательской трассировки, то ожидания готовности диска не будет,
                работа трассировки при этом не остановится. Системный аудит, наоборот, требует
                синхронную запись на диск, при которой возможны ожидания готовности диска к приему
                очередной порции данных.</para>

            <important>
                <para>Системный аудит может привести к созданию журнала с очень большим размером
                    (десятки гигабайт), поэтому необходимо обязательно убедиться, что на
                    соответствующем диске достаточно места для такого журнала.</para>
            </important>
            <para>Остановка пользовательского трассировки может быть выполнена либо интерактивно, то
                есть нажатием сочетания клавиш Ctrl-C, либо вводом команды
                    <application>fbsvcmgr</application> (или <application>fbtracemgr</application>)
                с передачей ей специального аргумента: <code>action_trace_stop trc_id
                    &lt;N&gt;</code> — что приведет к остановке трассировки без интерактивного
                вмешательства пользователя.</para>
            <para>Управление пользовательской трассировкой можно проводить как на самом сервере, где
                работает экземпляр Firebird, так и с другой машины, на которой установлен Firebird.
                При этом следует указывать IP-адрес удаленного сервера, порт прослушивания (3050 или
                другой), имя менеджера сервисов ('service_mgr') и команду, которую он должен
                выполнить (для запуска это <code>action_trace_start</code>). Примеры команд
                управления пользовательской трассировкой будут показаны ниже.</para>
            <para>Остановка системного аудита, работающего независимо от какой-либо из клиентских
                машин, возможно только через рестарт процесса Firebird (с изменением файла
                    <filename>firebird.conf</filename>, которое предотвратит новый старт
                аудита).</para>
        </section>
        <section>
            <title>Блочное представление информации</title>
            <para>События выводятся в виде простого текста, и каждое из них начинается с указания
                штампа даты-времени, за которым в скобках следует служебная информация, после чего —
                мнемоническое обозначение самого события:
                <screen>
    2017-12-04T13:16:47.8760 (25101:0x7f5e13868890) EXECUTE_STATEMENT_FINISH            
        </screen></para>
            <para>Реальная точность значений времени сервера — до миллисекунд.</para>
            <para>Все отслеживаемые события, за исключением сообщений о старте/финише сессий
                трассировки, имеют заголовочную информацию позволяющую идентифицировать, что за
                событие произошло, успешно ли оно завершилось (если речь идет об итоге чего-либо),
                какое приложение работало при этом, в какой именно базе данных это произошло, какие
                были ID у соединения и транзакции и другое.</para>
            <para>Таким образом, значительная часть информации в логе трассировки выглядит в каждом
                блоке одинаково. Например, в следующем фрагменте трассировки:
                <screen>
 1  2017-12-04T13:16:47.8760 (25101:0x7f5e13868890) EXECUTE_STATEMENT_FINISH
 2          production (ATT_41396268, JOHN:MANAGER, WIN1251, TCPv4:172.16.6.31)
 3          C:\App\stock_info.exe:1628
 4                  (TRA_393161255, READ_COMMITTED | REC_VERSION | WAIT | READ_ONLY)
 5
 6  Statement 499122858:
 7  -------------------------------------------------------------------------------
 8  select ...
 9  from ...
10
11
12  2017-12-04T13:16:47.9950 (25101:0x7f5e1386c390) EXECUTE_STATEMENT_FINISH
13          production (ATT_41396249, MARY:ACCOUNTANT, WIN1251, TCPv4:172.16.6.31)
14          C:\App\finance_garant:1604
15                  (TRA_393161257, READ_COMMITTED | REC_VERSION | WAIT | READ_ONLY)
16
17  Statement 499122478:
18  -------------------------------------------------------------------------------
19  select ...
20  from ...            
        </screen></para>
            <para>Видно, что строки, с номерами 1...4 и 12...15 имеют одинаковую структуру и
                содержат одинаковые теги для событий ('EXECUTE_STATEMENT_FINISH'), имени базы или её
                алиаса ('production'), ID подключения ('ATT_nnnnnnn'), и так далее.</para>
            <para>Недостаток у такого представления информации только один: избыточность. Но он
                перевешивается простотой визуального анализа журнала (лога): всё сосредоточено
                рядом, чаще всего нет необходимости в пролистывании лога вверх для получения
                дополнительных сведений.</para>
            <para>Кроме того: если каждое событие начинается одинаковым набором строк, то несложно
                написать скрипт для такой обработки трассировки, при котором все сведения о каждом
                событии (заголовок, текст SQL-запроса, статистика) будут рассматриваться как
                неделимые БЛОКИ. Это позволит затем переупорядочивать блоки и выводить информацию
                    <quote>поблочно</quote>, в нужном нам виде, например — в порядке убывания
                длительности выполнения операторов. Это позволит сразу получать перечень
                    <quote>узких мест</quote> в производительности приложения.</para>
        </section>
        <section>
            <title>Краткое описание работы. Типичный сценарий работы DBA</title>
            <para>Чтобы запустить трассировку, нужно сначала подготовить текстовый файл
                конфигурации, аналогичный <filename>firebird.conf</filename> (он также содержит пары
                вида: <quote>параметр = значение</quote>).</para>
            <para>Конфигурационный файл допускает указывать параметры для ФИЛЬТРАЦИИ таких
                категорий, как виды событий, длительность выполнения, печать плана, печать
                статистики, перечень кодов ошибок, перечень регулярных выражений — шаблонов для
                проверки на соответствие выполняемым SQL-выражениям, и другое.</para>
            <para>Фильтрация видов событий выполняется просто: нужно присвоить соответствующему
                параметру значение true.</para>
            <para>Фильтрация длительности выполнения запросов выполняется назначением минимального
                порога длительности (в миллисекундах). Все запросы, длящиеся выше этого значения
                    (<quote>медленные</quote>), будут рассматриваться на возможность их включения в
                лог трассировки. Все остальные запросы (<quote>быстрые</quote>) будут
                отбрасываться.</para>
            <para>Фильтрация кодов ошибок и отслеживаемых шаблонов выполняемых выражений выполняется
                по принципу проверки одному и/или двум задаваемым регулярным выражениям.<itemizedlist>
                    <listitem>
                        <para>Включающий фильтр. Работает по принципу допускаются только те, что
                            соответствуют регулярному выражению;</para>
                    </listitem>
                    <listitem>
                        <para>Исключающий фильтр. Работает по принципу допускаются все, за
                            исключением тех, что соответствуют регулярному выражению.</para>
                    </listitem>
                </itemizedlist></para>
            <para>Более подробно виды фильтрации будут рассмотрены далее в примерах.</para>
            <para>Типичный сценарий работы с трассировки — следующий:<orderedlist>
                    <listitem>
                        <para>Создается текстовый файл конфигурации для пользовательской трассировки:<orderedlist>
                                <listitem>
                                    <para>Проверяется шаблон заголовочной строки (<code>database =
                                            ...</code>). Этот шаблон должен удовлетворять правилам
                                        SIMILAR TO (см. далее).</para>
                                </listitem>
                                <listitem>
                                    <para>Особое внимание в нем уделяется параметру
                                            <parameter>time_threshold</parameter>, который оказывает
                                        самое сильное влияние на размер лога трассировки.</para>
                                </listitem>
                                <listitem>
                                    <para>Включается параметр регистрации завершения SQL-выражений:
                                            <code>log_statement_finish = true</code>.</para>
                                </listitem>
                                <listitem>
                                    <para>Включается параметр показа табличной статистики:
                                            <code>print_perf = true</code>.</para>
                                </listitem>
                                <listitem>
                                    <para>Включается параметр показа плана выполнения:
                                            <code>print_plan = true</code> (или <code>explain_plan =
                                            true</code>).</para>
                                </listitem>
                            </orderedlist></para>
                    </listitem>
                    <listitem>
                        <para>Запускается пользовательская трассировка с обязательным
                            перенаправлением его вывода в лог. Длительность работы — например, 5
                            минут.</para>
                    </listitem>
                    <listitem>
                        <para>По окончании работы трассировки останавливается.</para>
                    </listitem>
                    <listitem>
                        <para>Проводится анализ лога трассировки на предмет наличия в нём
                            SQL-выражений, который выполнялись дольше всего. Если имеется
                            скрипт/программа для <quote>блочного преобразования</quote> текста лога
                            трассировки, то её результатом должен быть тот же самый трассировки, но
                            в нем самыми первыми должны быть SQL-запросы с максимальной
                            длительностью.</para>
                    </listitem>
                </orderedlist></para>
        </section>
        <section>
            <title>Пользовательская трассировка и аудит: настройка, запуск и остановка</title>
            <para>До запуска трассировку надо настроить посредством редактирования текстового файла
                со строками вида "параметр = значение". Если запускается пользовательский трейс, то
                имя этого файла затем передается в строку-команду как значение одного из ключей.
                Если же запускается системный аудит, то имя этого файла прописывается в
                    <filename>firebird.conf</filename> в качестве значения параметра
                    <parameter>AuditTraceConfigFile</parameter>.</para>
            <para>Создаваемый файл конфигурации должен содержать параметр <code>enabled =
                    true</code>, чтобы трассировка или аудит смог начать выводить сообщения. В
                противном случае, все параметры файла конфигурации считаются выключенными и никаких
                сообщений в логе трассировки не будет. Этот параметр (<code>enabled = true |
                    false</code>) полезен, когда нужно временно запретить трассировке активность, но
                отменить его запуск нежелательно. По умолчанию параметр установлен в false, т.е. все
                прочие параметры будут считаться выключенными и трассировка при запуске не выдаст ничего.<orderedlist>
                    <listitem>
                        <para>Запуск пользовательского трассировке происходит так (путь к каталогу
                            Firebird — в нотации POSIX): <screen>
<![CDATA[
/opt/firebird/bin/fbsvcmgr localhost/3050:service_mgr action_trace_start 
  trc_cfg <подготовленная_trace_конфигурация.conf>
]]>                        
                    </screen>
                        </para>
                        <para>В этот момент на консоль или в лог будет выдано сообщение о том, какой
                            номер присвоен только что запущенной сессии трассировки. Этот номер
                            важен, если далее планируется корректная остановка именно
                                <quote>нашей</quote> сессии. Номер сессии трассировки можно получить
                            и с помощью отдельной команды, это делается так:
                            <screen>
/opt/firebird/bin/fbsvcmgr localhost/3050:service_mgr action_trace_list                        
                    </screen>
                        </para>
                        <para>Однако, эту команду следует вводить как можно быстрее после
                            предыдущей, чтобы уменьшить шансы получения <quote>чужого</quote>
                            номера. Когда трассировку надо остановить, следует использовать команду:
                            <screen>
/opt/firebird/bin/fbsvcmgr localhost/3050:service_mgr action_trace_stop trc_id <replaceable>&lt;N&gt;</replaceable>                        
                    </screen>
                            — где <replaceable>&lt;N&gt;</replaceable>; есть номер
                                <quote>нашей</quote> trace-сессии, полученный ранее. </para>
                    </listitem>
                    <listitem>
                        <para>Запуск системного аудита, как отмечалось выше, происходит
                            автоматически при рестарте Firebird. Его нельзя запустить
                                <quote>вручную</quote>. Аналогично, для остановки аудита требуется
                            остановить Firebird и сделать пустым (или закомментировать) значение
                            параметра <parameter>AuditTraceConfigFile</parameter> в
                                <filename>firebird.conf</filename> (см. также здесь:<link
                                xlink:href="https://www.firebirdsql.org/file/documentation/release_notes/html/ru/rlsnotes25.html#rnfb25-fbconf-audit"
                                >AuditTraceConfigFile</link>).</para>
                    </listitem>
                </orderedlist></para>

            <note>
                <para>Администратор может запустить любое количество пользовательских сессий
                    трассировки, с любыми конфигурационными файлами. Более того, запустить
                    трассировку в Firebird 3.0 может любой пользователь, но видеть он будет только
                    активность своей учетной записи.</para>
            </note>
        </section>
    </section>

    <section>
        <title>Использование таблиц мониторинга MON$</title>
        <para/>
    </section>
</chapter>
