<?xml version="1.0" encoding="UTF-8"?>
<?xml-model href="http://docbook.org/xml/5.1/rng/docbook.rng" schematypens="http://relaxng.org/ns/structure/1.0"?>
<?xml-model href="http://docbook.org/xml/5.1/sch/docbook.sch" type="application/xml" schematypens="http://purl.oclc.org/dsdl/schematron"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"
    version="5.1" xml:id="gstat" xml:lang="ru">
    <info>
        <title>Утилита GSTAT</title>
    </info>

    <indexterm>
        <primary>GSTAT</primary>
    </indexterm>

    <para><application>gstat</application> — это одна из утилит базы данных, поставляемых с
        Firebird. Она используется для отображения статистических данных о содержимом базы данных.
        Утилита <application>gstat</application> не подключается к базе данных, как это делают
        другие утилиты, вместо этого она открывает файлы базы данных напрямую и считывает
            <quote>сырые</quote> данные. Из-за этого <application>gstat</application> не использует
        транзакции, и некоторая статистика, которую он собирает, может включать данные, которые были
        удалены, например, обычными транзакциями базы данных.</para>

    <para>Утилита <application>gstat</application> возвращает информацию о дате создания базы
        данных, размере страниц базы данных, количестве теневых копий, таблицах, индексах и
        другую.</para>

    <para>Запуск <application>gstat</application> осуществляется следующим образом:
        <synopsis>
gstat [<replaceable>&lt;options&gt;</replaceable>] <replaceable>&lt;database&gt;</replaceable>            
        </synopsis>
        или
        <synopsis>
gstat <replaceable>&lt;database&gt;</replaceable> [<replaceable>&lt;options&gt;</replaceable>]           
        </synopsis>
    </para>

    <note>
        <para>Утилита <application>gstat</application> должна запускаться от имени пользователя
                <emphasis>root</emphasis> или пользователя <emphasis>firebird</emphasis>. Это
            связано с тем, что разрешения операционной системы по умолчанию при создании новой базы
            данных таковы, что только владелец — <emphasis>firebird</emphasis> — имеет доступ к
            файлам базы данных. Даже члены группы <emphasis>firebird</emphasis> по умолчанию не
            имеют доступа для чтения.</para>
    </note>

    <para>Имя базы данных <replaceable>&lt;database&gt;</replaceable> не может быть удаленной базой
        данных, оно должно быть локальным, но это может быть псевдоним для локальной базы данных.
        Причина, по которой оно должно быть локальным, заключается в том, что
            <application>gstat</application> работает на физическом уровне файлов, а не
        устанавливает соединение сервером базы данных — она читает файл базы данных напрямую.</para>

    <note>
        <para>Вы всё же можете получать статистику базы данных удалено, используя Service API. В
            Firebird существует консольная утилита FBSVCMGR для доступа к различным службам,
            использующим Service API.</para>
    </note>

    <para>Если <application>gstat</application> вызывается с неверным переключателем или с
        переключателем <code>-?</code>, то будет отображена справка по существующим переключателям.
        К сожалению, отображается только краткая форма переключателей.</para>
    <synopsis>
gstat -?        
    </synopsis>
    <screen>
<![CDATA[        
usage:   gstat [options] <database> or gstat <database> [options]
Available switches:
    -a      analyze data and index pages
    -d      analyze data pages
    -e      analyze database encryption
    -h      analyze header page ONLY
    -i      analyze index leaf pages
    -s      analyze system relations in addition to user tables
    -u      username
    -p      password
    -fetch  fetch password from file
    -r      analyze average record and version length
    -t      tablename <tablename2...> (case sensitive)
    -role   SQL role name
    -z      display version number
option -t accepts several table names only if used after <database>  
]]>
    </screen>
    <table frame="topbot">
        <title>Переключатели командной строки</title>
        <tgroup cols="2">
            <colspec colname="c1" colnum="1" colwidth="0.65*"/>
            <colspec colname="c2" colnum="2" colwidth="1.35*"/>
            <thead>
                <row>
                    <entry>Опция</entry>
                    <entry>Описание</entry>
                </row>
            </thead>
            <tbody>
                <row>
                    <entry><code>-a[ll]</code></entry>
                    <entry><para>Это переключатель по умолчанию, он эквивалентен <code>-h[eader]
                                -d[ata] -i[ndex]</code>.</para></entry>
                </row>
                <row>
                    <entry><code>-d[ata]</code></entry>
                    <entry><para>Получение статистики о данных всех или только указанных таблиц.
                            Пользовательские индексы, системные таблицы и системные индексы не
                            анализируются. Версии записей не анализируются.</para></entry>
                </row>
                <row>
                    <entry><code>-e[cryption]</code></entry>
                    <entry><para>Анализ шифрования базы данных.</para></entry>
                </row>
                <row>
                    <entry><code>-h[eader]</code></entry>
                    <entry>
                        <para>Этот переключатель отображает статистику о самой базе данных, а затем
                            завершает работу. Информация заголовка также отображается при
                            использовании любого другого переключателя, поэтому вы всегда получаете
                            подробные данные заголовка базы данных в своем выводе.</para>
                    </entry>
                </row>
                <row>
                    <entry><code>-i[ndex]</code></entry>
                    <entry>
                        <para>Указание этого параметра заставляет gstat анализировать каждый
                            пользовательский индекс в указанной базе данных. Пользовательские
                            таблицы, системные индексы и системные таблицы не анализируются. Если
                            указан переключатель <code>-t</code>, то анализируются только индексы
                            указанных таблиц.</para>
                    </entry>
                </row>
                <row>
                    <entry><code>-s[ystem]</code></entry>
                    <entry>
                        <para>Этот переключатель является модификатором и изменяет выходные данные
                            переключателей <code>-d[ata]</code> или <code>-i[ndex]</code>, включая
                            системные таблицы (или индексы) в дополнение к пользовательским таблицам
                            (или индексам). Использование этого переключателя само по себе
                            эквивалентно вызову <application>gstat</application> с указанным
                            параметром <code>-a[ll] -s[ystem]</code>.</para>
                        <para>При запуске этот переключатель отображает статистику для различных
                            таблиц и индексов RDB$ и MON$.</para>
                    </entry>
                </row>
                <row>
                    <entry><code>-u[sername]
                        <replaceable>&lt;username&gt;</replaceable></code></entry>
                    <entry><para>Позволяет указать имя пользователя: SYSDBA или пользователя
                            владельца базы данных. Его не нужно указывать, если переменная среды
                            ISC_USER существует и имеет правильное значение, или если вы вошли на
                            сервер под привилегированной учетной записью (root,
                        firebird).</para></entry>
                </row>
                <row>
                    <entry><code>-p[assword]
                        <replaceable>&lt;password&gt;</replaceable></code></entry>
                    <entry><para>Предоставляет пароль для имени пользователя, указанного
                            выше.</para></entry>
                </row>
                <row>
                    <entry><code>-fetch
                            {<replaceable>&lt;filename&gt;</replaceable>|stdin|/dev/tty}</code></entry>
                    <entry><para>Этот переключатель заставляет читать пароль из файла, а не
                            использовать тот, что указан в командной строке. Указанное имя файла не
                            должно быть в кавычках и должно быть доступно для чтения пользователю,
                            выполняющему <application>gstat</application>. Если имя файла указано
                            как stdin, то пользователю будет предложено ввести пароль. В системах
                            POSIX имя файла <filename>/dev/tty</filename> также приведет к запросу
                            пароля.</para></entry>
                </row>
                <row>
                    <entry><code>-r[ecord]</code></entry>
                    <entry>
                        <para>Ключ <code>-r[ecord]</code> является модификатором для ключей
                                <code>-d[ata]</code> и <code>-s[ystem]</code>. Он добавляет данные о
                            средней длине записи и версии для любых проанализированных таблиц данных
                            (пользовательских и/или системных). Этот ключ не влияет на ключ
                                <code>-i[ndex]</code>.</para>
                    </entry>
                </row>
                <row>
                    <entry><code>-t[able] <replaceable>&lt;tablename&gt;</replaceable> [...
                                <replaceable>&lt;tablename&gt;</replaceable>]</code></entry>
                    <entry>
                        <para>Этот переключатель позволяет анализировать таблицу или список таблиц,
                            а также любые индексы, принадлежащие указанным таблицам. Посмотрите
                            раздел предостережений ниже для некоторых потенциальных проблем с этим
                            переключателем и примером того, как его следует использовать.</para>
                        <para>За переключателем <code>-t[able]</code> должен следовать список имен
                            таблиц, которые вы хотите проанализировать. Список должен быть в верхнем
                            регистре, и каждая таблица разделена пробелом. Также можно использовать
                            двойные кавычки, чтобы <application>gstat</application> анализировал
                            таблицу, имя которой не указано в верхнем регистре.</para>
                        <para>Нет необходимости указывать ключ <code>-i[ndex]</code>, так как любые
                            индексы в указанных таблицах будут проанализированы. Информация
                            заголовка базы данных также отображается.</para>
                    </entry>
                </row>
                <row>
                    <entry><code>-role <replaceable>&lt;rolename&gt;</replaceable></code></entry>
                    <entry><para>Позволяет указать имя роли. Роль должна быть выдана пользователю
                            указанному в переключателей <code>-u[sername]</code>.</para></entry>
                </row>
                <row>
                    <entry><code>-tr</code></entry>
                    <entry><para>Использовать доверительную аутентификацию</para></entry>
                </row>
                <row>
                    <entry><code>-z</code></entry>
                    <entry><para>Это переключатель модификатор. Использование <code>-z</code>
                            отображает номер версии утилиты <application>gstat</application> и
                            сервера Firebird. Вы должны указать правильное имя базы данных и,
                            возможно, другой параметр. Этот переключатель добавляет информацию о
                            версии <application>gstat</application> и Firebird к выводу другого
                            переключателя, который вы указали, или по умолчанию, если вы его не
                            указали. Если все, что вам нужно, это информация о версии, то самый
                            короткий вывод будет если указать в переключателе <code>-t</code> не
                            существующую таблицу.</para>
                    </entry>
                </row>
            </tbody>
        </tgroup>
    </table>
    <section>
        <title>gstat примеры и интерпретация</title>

        <para>В этом разделе обсуждаются частые примеры использования сбора статистики и объясняется
            вывод утилиты.</para>

        <section>
            <title>Статистика заголовочной страницы</title>

            <para>Запустив утилиту gstat с ключом -h[eader] можно получить статистические данные о
                заголовочной странице указанной базы данных. Часть информации является статичной,
                часть — меняется в зависимости от происходящих в базе данных изменений. Пример
                информации с заголовочной страницы приводится ниже:</para>
            <synopsis>
gstat employee -header                
            </synopsis>
            <screen>
Database "C:\Firebird\3.0\examples\empbuild\employee.fdb"
Gstat execution time Sun Feb  9 12:45:13 2020

Database header page information:
        Flags                   0
        Generation              183
        System Change Number    3
        Page size               8192
        ODS version             12.0
        Oldest transaction      161
        Oldest active           162
        Oldest snapshot         162
        Next transaction        165
        Sequence number         0
        Next attachment ID      25
        Implementation          HW=AMD/Intel/x64 little-endian OS=Windows CC=MSVC
        Shadow count            0
        Page buffers            0
        Next header page        0
        Database dialect        3
        Creation date           Jan 31, 2020 12:42:02
        Attributes              force write

    Variable header data:
        Database backup GUID:   {B71E712F-377B-4526-5AB2-2B21879F2097}
        Sweep interval:         20000
        *END*
Gstat completion time Sun Feb  9 12:45:13 2020               
            </screen>
            <para> Первая строка вывода отображает имя файла(ов) и путь к базе данных. Это может
                быть полезно, если задан псевдоним базы данных, и необходимо точно определить, где
                находится база данных. Поскольку база данных сотрудников является однофайловой,
                отображается только один файл. Если бы это была многофайловая база данных, конец
                перечисленного выше выглядел бы следующим образом:</para>
            <screen>
...
    Variable header data:
        Continuation file:       C:\Firebird\3.0\examples\empbuild\employee_multy.fdb1
        Last logical page:       162                
            </screen>
            <para>Описание различных полей заголовка описаны ниже.</para>
            <para><emphasis role="bold">Flags</emphasis> — это набор флагов, определяющий важные
                особенности поведения базы данных. Флаги устанавливаются только с помощью
                специальных инструментов вроде <application>gfix</application>, изменять флаги с
                помощью других инструментов опасно — это может привести к порче базы данных. </para>
            <para>Надо сказать, что при получении статистики показывается, что значение параметра
                    <emphasis role="bold">Flags</emphasis> всегда равно нулю, вне зависимости от
                установленных флагов.</para>
            <para><emphasis role="bold">Generation</emphasis> — это счетчик, который увеличивается
                на единицу всякий раз, когда заголовочная страница записывается на диск.</para>
            <para><emphasis role="bold">System Change Number</emphasis> — маркер (число от 0 до 3),
                которым помечаются страницы базы данных при создании инкрементных копий с помощью
                утилиты nbackup. Nbackup выполняет резервное копирование страниц базы данных,
                копируя страницы, которые были изменены с момента последней резервной копии
                непосредственно предшествующего уровня. Если делается резервная копия уровня 0,
                копируются все страницы, а если уровня 1 — копируются только те страницы, которые
                были изменены после последнего уровня 0. Чтобы иметь возможность находить измененные
                страницы, Firebird использует маркер, который называется SCN. Это число
                увеличивается при каждом изменении состояния резервной копии и не зависит от уровня
                резервного копирования.</para>
            <itemizedlist>
                <listitem>
                    <para>0 — страницы перед резервным копированием; </para>
                </listitem>
                <listitem>
                    <para>1 — страницы, записанные в дельта-файл во время резервного копирования;
                    </para>
                </listitem>
                <listitem>
                    <para>2 — страницы, записанные во время слияния дельта-файла с основной
                        резервной копией;</para>
                </listitem>
                <listitem>
                    <para>3 — страницы, записанные после окончания первого бэкапа и слияния. </para>
                </listitem>
            </itemizedlist>
            <para>Резервное копирование и восстановление с помощью <application>gbak</application>
                не восстанавливает содержимое таблицы <database>RDB$BACKUP_HISTORY</database> и
                сбрасывает SCN всех страниц обратно на 0. Таким образом, восстановление с помощью
                    <application>gbak</application> перепишет всю базу данных (и может даже изменить
                размер страницы). Это делает предыдущие резервные копии с помощью
                    <application>nbackup</application> бессмысленными в качестве отправной точки для
                последующих резервных копий: нужно начать заново с уровня 0.</para>
            <para><emphasis role="bold">Page size</emphasis> — размер страницы базы данных,
                исчисляется в байтах. Все файлы одной базы данных состоят из страниц одинакового
                размера, который устанавливается при создании базы данных и при восстановлении базы
                данных из резервной копии. Множество важнейших параметров сервера зависят от размера
                страницы — например, кеш базы данных. Рекомендуют создавать базу данных с размером
                страниц не менее 4096 байт, а лучше 8192 или 16384 байта.</para>
            <para><emphasis role="bold">ODS version</emphasis> – версия структуры базы данных на
                диске (On-Disk Structure). Представляет собой два числа, разделенные точкой. "Целая"
                часть — это основная версия ODS, которая зависит от версии сервера, создавшего
                данную базу данных. Главная версия определяет основные возможности работы с базой
                данных, и ее значение присваивается при создании (восстановлении) базы данных.
                "Дробная" часть (после точки) — это минорная версия ODS.</para>
            <para>Значения, которые вы можете увидеть здесь:</para>
            <para>
                <itemizedlist spacing="compact">
                    <listitem>
                        <para>10.0 — Firebird 1.0;</para>
                    </listitem>
                    <listitem>
                        <para>10.1 — Firebird 1.5;</para>
                    </listitem>
                    <listitem>
                        <para>11.0 — Firebird 2.0;</para>
                    </listitem>
                    <listitem>
                        <para>11.1 — Firebird 2.1;</para>
                    </listitem>
                    <listitem>
                        <para>11.2 — Firebird 2.5;</para>
                    </listitem>
                    <listitem>
                        <para>12.0 — Firebird 3.0;</para>
                    </listitem>
                    <listitem>
                        <para>13.0 — Firebird 4.0.</para>
                    </listitem>
                </itemizedlist>
            </para>
            <para><emphasis role="bold">Детали транзакций</emphasis>: <itemizedlist>
                    <listitem>
                        <para><emphasis role="bold">Oldest transaction</emphasis> — идентификатор
                            старейшей заинтересованной транзакции в базе данных (Oldest Interesting
                            Transaction или OIT). Первая транзакция с состоянием, отличным от
                            commit. На практике это: <itemizedlist>
                                <listitem>
                                    <para>Oldest Active Transaction;</para>
                                </listitem>
                                <listitem>
                                    <para>номер самой старой транзакции, завершенной "настоящим"
                                        rollback (выполняется если пользователь в одной транзакции
                                        модифицировал более 100000 записей); </para>
                                </listitem>
                                <listitem>
                                    <para>транзакция в состоянии in-limbo (полузавершенная)
                                        двухфазного commit. </para>
                                </listitem>
                            </itemizedlist></para>
                        <para>Значение этого параметра часто сравнивается с Oldest active. Разница
                            этих параметров влияет на автоматический запуск sweep.</para>
                    </listitem>
                    <listitem>
                        <para><emphasis role="bold">Oldest active</emphasis> — старейшая транзакция,
                            которую пользователь стартовал, и до сих пор не завершил по commit или
                            rollback (Oldest Active Transaction или OAT). </para>
                    </listitem>
                    <listitem>
                        <para><emphasis role="bold">Oldest snapshot</emphasis> — номер последней
                            транзакции snapshot, которая влияет на процесс сборки мусора (Oldest
                            Snapshot Transaction или OST). OST — это старейший <quote>номер
                                snapshot</quote> для всех активных транзакций. Транзакция
                                <emphasis>read-only, read committed</emphasis> не имеет
                                <quote>номера snapshot</quote>. Транзакция <emphasis>read-write,
                                read committed</emphasis> имеет <quote>номер snapshot</quote> равный
                            своему собственному номеру. Для транзакции snapshot <quote>номер
                                snapshot</quote> — это номер Oldest Active Transaction на момент ее
                            старта. Номер Oldest Snapshot Transaction обновляется, когда стартует
                            новая транзакция (или выполняется commit retaining) или когда стартует
                            sweep. Транзакции с таким или большим номер не подлежат сборке
                            мусора.</para>
                    </listitem>
                    <listitem>
                        <para><emphasis role="bold">Next transaction</emphasis> — это просто номер,
                            который будет присвоен следующей транзакции при её старте.</para>
                    </listitem>
                </itemizedlist></para>
            <para>Если вы заметили, что разница между OAT и Next transaction постоянно
                увеличивается, значит какие-то транзакции не подтверждаются должным образом и
                следовательно может накапливаться все большее число мусорных записей. В конце концов
                вы увидите, что время запуска базы данных увеличивается, а производительность
                падает. Если разница между OIT и OAT велика, значит sweep не запускался в
                автоматическом или ручном режиме. В таком случае возможно следует запустить
                    <application>gfix</application> для сборки мусора вручную.</para>
            <para>
                <emphasis role="bold">Sequence number</emphasis> — порядковый номер файла базы
                данных. Для базы данных, состоящей из одного файла, он всегда равен нулю. Второй
                файл в базе данных будет иметь номер 1 и так далее. </para>
            <para><emphasis role="bold">Next attachment ID</emphasis> — номер следующего соединения
                к этой базе данных. Каждый раз, когда приложение подключается к базе данных, это
                число увеличивается на один. Запуск и завершение работы базы данных также
                увеличивает этот номер. Запуск <application>gstat</application> не изменяет этот
                идентификатор.</para>
            <para>
                <emphasis role="bold">Implementation</emphasis> — аппаратная архитектура, на которой
                была создана база данных.</para>
            <para><emphasis role="bold">Shadow count</emphasis> — количество файлов теневых копий,
                которые определены для данной базы данных.</para>
            <para><emphasis role="bold">Page buffers</emphasis> — размер кэша базы данных в
                страницах. Ноль означает, что база данных использует значение параметра
                    <parameter>DefaultDbCachePages</parameter> из файла конфигурации
                    (<filename>firebird.conf</filename> или
                <filename>databases.conf</filename>).</para>
            <para><emphasis role="bold">Next header page</emphasis> — номер следующей заголовочной
                страницы. Всегда равен нулю. Собственно говоря, любая страница в базе данных имеет
                ссылку на номер следующей страницы такого же типа,но так как заголовочная страница
                всегда единственная в каждом файле базы данных, то у нее эта ссылка обнулена.</para>
            <para><emphasis role="bold">Database dialect</emphasis> — диалект SQL базы
                данных.</para>
            <para><emphasis role="bold">Creation date</emphasis> — дата создания базы данных или
                последнего восстановления из резервной копии.</para>
            <para><emphasis role="bold">Attributes</emphasis> — различные атрибуты базы данных.
                Возможны следующий значения: <itemizedlist spacing="compact">
                    <listitem>
                        <para>forced write — режим принудительной записи включен (forced write
                            on).</para>
                    </listitem>
                    <listitem>
                        <para>no reserve — указывает, что на страницах не резервируется место для
                            старых версий данных. Это позволяет более плотно упаковывать данные на
                            каждой странице, в силу чего база данных занимает меньше дискового
                            пространства. Это хорошо для баз данных только для чтения, однако
                            негативно отражается на базах данных в которых необходимо производить
                            обновления или удаление записей.</para>
                    </listitem>
                    <listitem>
                        <para>read only — база данных работает в режиме Read Only. Если флаг не
                            установлен, то допустимы как чтение, так и запись.</para>
                    </listitem>
                    <listitem>
                        <para>multi-user maintenance — база данных блокирована в режиме multi.
                            Множество соединений разрешены только для SYSDBA или владельца базы
                            данных.</para>
                    </listitem>
                    <listitem>
                        <para>single-user maintenance — база данных блокирована в режиме single.
                            Только одно соединение разрешено для SYSDBA или владельца базы
                            данных.</para>
                    </listitem>
                    <listitem>
                        <para>full shutdown — база данных блокирована в режиме full.</para>
                    </listitem>
                    <listitem>
                        <para>backup lock — Основной файл базы данных временно заблокирован.
                            Изменения фиксируются во временном файле дельты.</para>
                    </listitem>
                    <listitem>
                        <para>backup merge — Объединение файла дельты с основным файлом базы
                            данных.</para>
                    </listitem>
                </itemizedlist></para>
            <para><emphasis role="bold">Variable header data</emphasis> — переменные данные
                заголовочной страницы. Эта часть отчета охватывает информацию, которой нет в
                фиксированной части заголовка базы данных. Например, интервал очистки (sweep
                interval), GUID базы даных, GUID последней резервной копии и другое.</para>
        </section>

        <section>
            <title>Анализ всей базы данных</title>

            <para/>
        </section>

        <section>
            <title>Анализ только страниц с данным</title>

            <para/>
        </section>

        <section>
            <title>Анализ только индексов</title>

            <para/>
        </section>

        <section>
            <title>Выбор таблиц для анализа</title>

            <para/>
        </section>

        <section>
            <title>Включение в статистику системных таблиц и индексов</title>

            <para/>
        </section>

        <section>
            <title>Включение в статистику системных таблиц и индексов</title>

            <para/>
        </section>

        <section>
            <title>Статистика размеров записей и версий</title>

            <para/>
        </section>
    </section>

</chapter>
