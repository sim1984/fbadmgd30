<?xml version="1.0" encoding="UTF-8"?>
<?xml-model href="http://docbook.org/xml/5.1/rng/docbook.rng" schematypens="http://relaxng.org/ns/structure/1.0"?>
<?xml-model href="http://docbook.org/xml/5.1/sch/docbook.sch" type="application/xml" schematypens="http://purl.oclc.org/dsdl/schematron"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"
    version="5.1" xml:id="gbak" xml:lang="ru">
    <info>
        <title>Утилита GBAK</title>
    </info>
    <indexterm>
        <primary>GBAK</primary>
    </indexterm>
    <para>Утилита <application>gbak</application> позволяет выполнять резервное копирование или
        восстановление базы данных с возможностью изменения указанных характеристик базы
        данных.</para>

    <para>Запуск <application>gbak</application> без аргументов (или с неверным переключателем) или
        с переключателем <code>-?</code> приводит к отображению следующего экрана справочной
        информации: <screen><![CDATA[        
gbak:Usage:
     gbak -b <db set> <backup set> [backup options] [general options]
     gbak -c <backup set> <db set> [restore options] [general options]
     <db set> = <database> | <db1 size1>...<dbN> (size in db pages)
     <backup set> = <backup> | <bk1 size1>...<bkN> (size in bytes = n[K|M|G])
     -recreate overwrite and -replace can be used instead of -c
gbak:legal switches are:
    -B(ACKUP_DATABASE)    backup database to file
    -C(REATE_DATABASE)    create database from backup file (restore)
    -R(ECREATE_DATABASE) [O(VERWRITE)] create (or replace if OVERWRITE used)
                                database from backup file (restore)
    -REP(LACE_DATABASE)   replace database from backup file (restore)
gbak:backup options are:
    -CO(NVERT)            backup external files as tables
    -E(XPAND)             no data compression
    -FA(CTOR)             blocking factor
    -G(ARBAGE_COLLECT)    inhibit garbage collection
    -IG(NORE)             ignore bad checksums
    -L(IMBO)              ignore transactions in limbo
    -NOD(BTRIGGERS)       do not run database triggers
    -NT                   Non-Transportable backup file format
    -OL(D_DESCRIPTIONS)   save old style metadata descriptions
    -T(RANSPORTABLE)      transportable backup -- data in XDR format
gbak:restore options are:
    -BU(FFERS)            override page buffers default
    -FIX_FSS_D(ATA)       fix malformed UNICODE_FSS data
    -FIX_FSS_M(ETADATA)   fix malformed UNICODE_FSS metadata
    -I(NACTIVE)           deactivate indexes during restore
    -K(ILL)               restore without creating shadows
    -MO(DE) <access>      "read_only" or "read_write" access
    -N(O_VALIDITY)        do not restore database validity conditions
    -O(NE_AT_A_TIME)      restore one table at a time
    -P(AGE_SIZE)          override default page size
    -USE_(ALL_SPACE)      do not reserve space for record versions
gbak:general options are:
    -FE(TCH_PASSWORD)     fetch password from file
    -M(ETA_DATA)          backup or restore metadata only
    -PAS(SWORD)           Firebird password
    -RO(LE)               Firebird SQL role
    -SE(RVICE)            use services manager
    -SKIP_D(ATA)          skip data for table
    -ST(ATISTICS) TDRW    show statistics:
        T                 time from start
        D                 delta time
        R                 page reads
        W                 page writes
    -TRU(STED)            use trusted authentication
    -USER                 Firebird user name
    -V(ERIFY)             report each action taken
    -VERBI(NT) <n>        verbose information with explicit interval
    -Y  <path>            redirect/suppress status message output
    -Z                    print version number
gbak:switches can be abbreviated to the unparenthesized characters        
]]></screen>
    </para>

    <para>Формат команд и список доступных переключателей отличается при создании резервной копи и
        восстановлении. Эти режимы работы и их переключатели будут описаны отдельно, а сейчас
        приведём список переключателей, которые являются общими для обоих режимов работы.</para>

    <section>
        <title>Общие опции</title>

        <para>Следующие параметры применимы как в режиме резервного копирования, так и в режиме
            восстановления базы данных.</para>

        <table frame="topbot">
            <title>Команды и опции утилиты GBAK</title>
            <tgroup cols="2">
                <colspec colname="c1" colnum="1" colwidth="0.75*" align="left"/>
                <colspec colname="c2" colnum="2" colwidth="1.25*" align="left"/>
                <thead>
                    <row>
                        <entry>Опция</entry>
                        <entry>Описание</entry>
                    </row>
                </thead>
                <tbody>
                    <row>
                        <entry><code>-FE[TCH_PASSWORD]
                                <replaceable>&lt;filename&gt;</replaceable></code></entry>
                        <entry>
                            <para>Извлекает пароль из файла. Если имя файла указано как stdin, то
                                пользователю будет предложено ввести пароль. В системах POSIX имя
                                файла <filename>/dev/tty</filename> также приведет к запросу
                                пароля.</para></entry>
                    </row>
                    <row>
                        <entry><code>-M[ETADATA]</code></entry>
                        <entry><para>Этот переключатель приводит к тому, что ваши данные
                                игнорируются, а не копируются и не восстанавливаются. При резервном
                                копировании копируются только метаданные базы данных. При
                                восстановлении любые данные в файле дампа не будут
                                восстановлены.</para></entry>
                    </row>
                    <row>
                        <entry><code>-PAS[SWORD]
                            <replaceable>&lt;password&gt;</replaceable></code></entry>
                        <entry><para>Пароль пользователя, подключающегося к базе данных для
                                резервного копирования, или используемый при создании БД в режиме
                                восстановления.</para>
                            <para>Этот ключ не нужно указывать, если установлена переменная среды
                                    <envar>ISC_PASSWORD</envar>, а так же при использовании
                                переключателя <code>-FE[TCH_PASSWORD]</code>, или доверительной
                                аутентификации. </para></entry>
                    </row>
                    <row>
                        <entry><code>-RO[LE]
                            <replaceable>&lt;rolename&gt;</replaceable></code></entry>
                        <entry><para>Позволяет указать роль, которая будет использоваться
                                подключающимся пользователем.</para></entry>
                    </row>
                    <row>
                        <entry><code>-SE[RVICE]
                            <replaceable>&lt;service&gt;</replaceable></code></entry>
                        <entry><para>Указывает диспетчер служб.</para>
                            <para>Для локального соединения используйте просто имя диспетчера служб,
                                которое всегда должно быть <code>service_mgr</code>.</para>
                            <para>Чтобы присоединить к удаленной машине необходимо дописать имя
                                хоста в одном из следующих форматов с зависимости от используемого
                                протокола: <itemizedlist>
                                    <listitem>
                                        <para>TCP/IP —
                                                  <code><replaceable>hostname</replaceable>[/<replaceable>port</replaceable>]:service_mgr</code></para>
                                    </listitem>
                                    <listitem>
                                        <para>WNET —
                                                  <code><replaceable>\\hostname</replaceable>[@<replaceable>port</replaceable>]:service_mgr</code></para>
                                    </listitem>
                                    <listitem>
                                        <para>XNET — <code>service_mgr</code></para>
                                    </listitem>
                                </itemizedlist></para>
                            <para>Кроме того вы можете использовать обобщённый URL-подобный
                                синтаксис
                                <programlisting>
<replaceable>&lt;protocol&gt;</replaceable>://[<replaceable>hostname</replaceable>[:<replaceable>port</replaceable>]/]service_mgr   
                                
<replaceable>&lt;protocol&gt;</replaceable> ::= inet|inet4|inet6|wnet|xnet                                
                            </programlisting>
                            </para>
                            <para>При использовании локального протокола (XNET) имя хоста указывать
                                не нужно.</para>
                        </entry>
                    </row>
                    <row>
                        <entry><code>-SKIP_D[ATA]
                            <replaceable>&lt;pattern&gt;</replaceable></code></entry>
                        <entry><para>Пропускает данные таблиц, имена которых соответствуют
                                указанному здесь регулярному выражению в SQL-синтаксисе (см.
                                оператор SIMILAR TO).</para></entry>
                    </row>
                    <row>
                        <entry><code>-ST[ATISTICS] TRWD</code></entry>
                        <entry><para>Выводит статистику в процессе работы (работает вместе с
                                -V[ERIFY]).</para>
                            <para>
                                <itemizedlist>
                                    <listitem>
                                        <para>T — время от начала работы gbak;</para>
                                    </listitem>
                                    <listitem>
                                        <para>D — время прошедшее с последнего вывода на
                                            экран;</para>
                                    </listitem>
                                    <listitem>
                                        <para>R — число страниц прочитанных с последнего вывода на
                                            экран;</para>
                                    </listitem>
                                    <listitem>
                                        <para>W — число страниц записанных с последнего вывода на
                                            экран.</para>
                                    </listitem>
                                </itemizedlist>
                            </para>
                        </entry>
                    </row>
                    <row>
                        <entry><code>-TRU[STED]</code></entry>
                        <entry><para>Использовать доверительную аутентификацию.</para></entry>
                    </row>
                    <row>
                        <entry><code>-U[SER]
                            <replaceable>&lt;username&gt;</replaceable></code></entry>
                        <entry><para>Позволяет указать имя пользователя SYSDBA или пользователя
                                владельца базы данных, если необходимо выполнить резервное
                                копирование базы данных.</para>
                            <para>При восстановлении базы данных позволяет указать любого
                                пользователя у которого есть привилегия <code>CREATE
                                DATABASE</code>. Этот пользователь будет владельцем восстановленной
                                базы данных.</para>
                            <para>Этот ключ не нужно указывать, если установлена переменная среды
                                    <envar>ISC_ISC_USER</envar>, или при использовании доверительной
                                аутентификации. </para>
                        </entry>
                    </row>
                    <row>
                        <entry><code>-V[ERIFY]</code></entry>
                        <entry><para>Отчет о каждом выполненном действии.</para>
                            <para>Обычно gbak работает молчаливо, и информация не выводится на
                                дисплей. Этот переключатель изменяет ситуацию и вызывает отображение
                                большого количества информации.</para>
                            <para>При использовании этого переключателя по умолчанию информация
                                выводится на экран, но вы можете перенаправить её в файл, используя
                                ключ <code>-y</code>.</para>
                        </entry>
                    </row>
                    <row>
                        <entry><code>-VERBI[NT] <replaceable>&lt;n&gt;</replaceable></code></entry>
                        <entry><para>Подробный вывод лога действии с заданным интервалом
                                времени.</para></entry>
                    </row>
                    <row>
                        <entry><code>-Y <replaceable>&lt;log_filename&gt;</replaceable> |
                                suppress</code></entry>
                        <entry><para>Вывод лога действий в указанный файл.</para>
                            <para>Используется вместе с ключом <code>-v[erify]</code> для
                                перенаправления сообщений о состоянии в файл или устройство, а не на
                                экран, или для их полного подавления.</para>
                            <para>Если используется <code>-y suppress</code>, то никакая информация
                                не будет записываться на экран независимо от того, указан ли
                                    <code>-v[erify]</code>.</para>
                            <para>Если задано имя файла и указан ключ <code>-v[erify]</code>, то
                                сообщения о прогрессе и предупреждениях будут записаны в указанный
                                файл.</para>
                        </entry>
                    </row>
                    <row>
                        <entry><code>-Z</code></entry>
                        <entry><para>Вывод версии gbak и версии сервера Firebird.</para></entry>
                    </row>
                </tbody>
            </tgroup>
        </table>
        <note>
            <para>Параметр <code>-v</code> в справке, выдаваемой <application>gbak</application>,
                описан как <code>-v[erify]</code>. Это неверно, потому что опция
                    <application>gbak</application>
                <code>-v</code> не имеет ничего общего с проверкой БД. Скорее, этот параметр должен
                расшифровываться как <quote>verbose</quote>.</para>
        </note>

        <section>
            <title>Использование диспетчера служб</title>

            <para>В обычном режиме при создании резервной копии gbak самостоятельно читает с сервера
                метаданные и данные из записывает их в файл резервной копии. При восстановлении gbak
                читает файл резервной копии и отправляет серверу инструкции для
                восстановления.</para>

            <para>При использовании диспетчера служб gbak только даёт команду начать резервную копию
                или восстановление серверу, и он сам делает это. Однако gbak может принимать лог
                действий от сервера, который будет вестись при указании ключа
                <code>-v[erify]</code>. В этом случае при создании резервной копии файлы копии будут
                создаваться на сервере. Для возможности восстановления базы данных файлы резервной
                копии так же должны находится на сервере.</para>

            <para>Для использования диспетчера служб необходимо указать параметр <code>-SE[RVICE]
                        <replaceable>&lt;service&gt;</replaceable></code>.</para>
            <para>Для локального соединения используйте просто имя диспетчера служб, которое всегда
                должно быть <code>service_mgr</code>.</para>
            <para>Чтобы присоединить к удаленной машине необходимо дописать имя хоста в одном из
                следующих форматов с зависимости от используемого протокола: <itemizedlist>
                    <listitem>
                        <para>TCP/IP —
                                    <code><replaceable>hostname</replaceable>[/<replaceable>port</replaceable>]:service_mgr</code></para>
                    </listitem>
                    <listitem>
                        <para>WNET —
                                    <code><replaceable>\\hostname</replaceable>[@<replaceable>port</replaceable>]:service_mgr</code></para>
                    </listitem>
                    <listitem>
                        <para>XNET — <code>service_mgr</code></para>
                    </listitem>
                </itemizedlist></para>
            <para>Кроме того вы можете использовать обобщённый URL-подобный синтаксис
                <programlisting>
<replaceable>&lt;protocol&gt;</replaceable>://[<replaceable>hostname</replaceable>[:<replaceable>port</replaceable>]/]service_mgr   
                                
<replaceable>&lt;protocol&gt;</replaceable> ::= inet|inet4|inet6|wnet|xnet                                
                            </programlisting>
            </para>
            <para>При использовании локального протокола (XNET) имя хоста указывать не нужно.</para>

            <important>
                <para>Если используете диспетчер служб, то не надо указывать спецификацию удалённого
                    хоста в имени базы данных как при резервном копировании, так и при
                    восстановлении.</para>
            </important>
        </section>
    </section>

    <section>
        <title>Создание резервных копий</title>

        <para>gbak создает непротиворечивую резервную копию базы данных, начиная транзакцию в режиме
            изолированности SNAPSHOT, которая охватывает весь период резервного копирования. В
            процессе резервного копирования gbak читает и сохраняет в специальный файл (или файлы)
            метаданные (описания таблиц, процедур, триггеров и т. д.) и данные таблиц. Любые
            изменения, сделанные транзакциями запущенными после начала резервного копирования, не
            попадут в файл резервной копии. Таким образом резервная копия будет представлять собой
            копию всей базы данных на момент начала резервного копирования. Это позволяет
            приложениям беспрепятственно работать с базой данных во время резервного
            копирования.</para>

        <para>Для возможности резервного копирования пользователь должен быть авторизован как SYSDBA
            быть владельцем базы данных или обладать административными привилегиями в ней
            (соединиться с ролью RDB$ADMIN).</para>

        <para>Формат командной строки для создания резервной копии выглядит следующим образом:
            <programlisting>
gbak -b <replaceable>&lt;database&gt;</replaceable> <replaceable>&lt;backup set&gt;</replaceable> [<replaceable>backup options</replaceable>] [<replaceable>general options</replaceable>]   
                
<replaceable>&lt;backup set&gt;</replaceable> ::= <replaceable>backup_file</replaceable> | {<replaceable>bk1</replaceable> <replaceable>size1</replaceable>}...<replaceable>bkN</replaceable>                

<replaceable>&lt;database&gt;</replaceable> ::= [<replaceable>&lt;server_spec&gt;</replaceable>]{<replaceable>filepath</replaceable> | <replaceable>db_alias</replaceable>}     

<replaceable>&lt;server_spec&gt;</replaceable> ::= 
    <replaceable>hostname</replaceable>[\<replaceable>port</replaceable> | <replaceable>service</replaceable>]: 
  | \\<replaceable>hostname</replaceable>[@<replaceable>port</replaceable> | <replaceable>service</replaceable>]\ 
  | <replaceable>&lt;protocol&gt;</replaceable>://[<replaceable>hostname</replaceable>[:<replaceable>port</replaceable> | <replaceable>service</replaceable>]/]

<replaceable>&lt;protocol&gt;</replaceable> = inet | inet4 | inet6 | wnet | xnet
            </programlisting>
        </para>

        <section>
            <title>Опции резервного копирования</title>

            <table frame="topbot">
                <title>Опции резервного копирования утилиты GBAK</title>
                <tgroup cols="2">
                    <colspec colname="c1" colnum="1" colwidth="0.75*" align="left"/>
                    <colspec colname="c2" colnum="2" colwidth="1.25*" align="left"/>
                    <thead>
                        <row>
                            <entry>Опция</entry>
                            <entry>Описание</entry>
                        </row>
                    </thead>
                    <tbody>
                        <row>
                            <entry><code>-B[ACKUP_DATABASE]</code></entry>
                            <entry>
                                <para>Создать резервную копию.</para></entry>
                        </row>
                        <row>
                            <entry><code>-CO[NVERT]</code></entry>
                            <entry><para>Конвертировать внешние таблицы во внутренние таблицы базы
                                    данных.</para></entry>
                        </row>
                        <row>
                            <entry><code>-E[XPAND]</code></entry>
                            <entry><para>Отключение сжатия данных при резервном копировани. По
                                    умолчанию резервная копия записывается в <quote>сжатом</quote>
                                    виде.</para></entry>
                        </row>
                        <row>
                            <entry><code>-FA[CTOR]
                                <replaceable>&lt;n&gt;</replaceable></code></entry>
                            <entry><para>При резервном копировании на физическое ленточное
                                    устройство этот переключатель позволяет указать коэффициент
                                    блокировки ленты. Атавизм.</para></entry>
                        </row>
                        <row>
                            <entry><code>-G[ARBAGE_COLLECT]</code></entry>
                            <entry><para>Отключение сборки мусора во время резервного копирования. </para>
                                <para>gbak подключается к базе данных как и любое обычное
                                    приложение. Обычно при чтении таблиц сервер проверяет записи на
                                    наличие мусора, и в случае его обнаружения убирает его.
                                    Использование этого параметра предотвращает запуск сборки мусора
                                    во время резервного копирования. Это может помочь ускорить
                                    резервное копирование. </para>
                            </entry>
                        </row>
                        <row>
                            <entry><code>-IG[NORE]</code></entry>
                            <entry><para>Этот переключатель заставляет gbak игнорировать неверные
                                    контрольные суммы в базе данных.</para>
                                <para>В обычной командной строке для создания резервной копии базы
                                    данных категорически не рекомендуется указывать параметр
                                        <code>-ig</code>! Если база данных вдруг окажется
                                    повреждена, то с этим параметром вы можете <quote>не
                                        увидеть</quote> повреждение. Так что, <code>-ig</code> для
                                    gbak используется только в крайнем случае – когда поврежденная
                                    база починена утилитой gfix, но обычная резервная копия не
                                    проходит. Только тогда имеет смысл повторить создание резервной
                                    копии с опцией <code>-ig</code>.</para>
                            </entry>
                        </row>
                        <row>
                            <entry><code>-L[IMBO]</code></entry>
                            <entry><para>Игнорировать зависшие двухфазные транзакции (limbo).</para>
                                <para>Не сохраняет в резервной копии БД версии записей, которые
                                    созданы транзакциями, находящимися в состоянии in limbo. Такое
                                    состояние может быть только у не завершившихся транзакций
                                    двухфазного коммита (2PC). Если приложения не используют
                                    двухфазный коммит, или вы не знаете, что это такое, то этот
                                    параметр вам никогда не понадобится.</para>
                            </entry>
                        </row>
                        <row>
                            <entry><code>-NOD[BTRIGGERS]</code></entry>
                            <entry><para>Не запускать триггеры уровня базы данных.</para></entry>
                        </row>
                        <row>
                            <entry><code>-NT</code></entry>
                            <entry><para>Формат резервной копии, непереносимой между аппаратными
                                    платформами.</para>
                                <para>Если вы используете этот переключатель для создания резервной
                                    копии, вы можете восстановить ее только на аналогичной
                                    платформе. </para>
                            </entry>
                        </row>
                        <row>
                            <entry><code>-OL[D_DESCRIPTIONS]</code></entry>
                            <entry><para>Устарел. Требовался для создания резервных копий в формате
                                    совместимом с Interbase 3.3.</para></entry>
                        </row>
                        <row>
                            <entry><code>-T[RANSPORTABLE]</code></entry>
                            <entry>
                                <para>Создаёт транспортабельную (переносимую) резервную
                                    копию.</para>
                                <para>Формат файла резервную копии по умолчанию является
                                    переносимым, поэтому указывать данный переключатель не следует.
                                    Переносимые файлы резервных копий записываются в формате,
                                    известном как формат представления внешних данных (XDR). Такой
                                    файл резервной копии можно восстановить на альтернативной
                                    аппаратной платформе, где порядок байт в целых числах
                                    отличается. То есть, например, между Intel и Sparc, или HP-UX и
                                    Intel, и так далее. Но между Windows и Linux (или другой ОС) на
                                    Intel файл резервной копии будет и так переносимым, даже при
                                    указании ключа <code>-nt</code> (non-transportable).
                                </para></entry>
                        </row>
                    </tbody>
                </tgroup>
            </table>
        </section>
        <section>
            <title>Имя базы данных</title>

            <para>Как уже было сказано, что gbak это обычная программа, которая читает данные из
                базы данных, то сама база данных и сервер могут находиться где угодно. </para>

            <para>Если база данных распложено локально, то достаточно просто указать путь к
                первичному файлу базы данных или её псевдоним. Пример:
                <programlisting>
gbak -b C:\data\my.fdb D:\backup\my.fbk ...   
</programlisting>
                или с использованием алиаса
                <programlisting>
gbak -b mydb D:\backup\my.fbk ...   
</programlisting>
            </para>

            <para>Если же база данных расположено на удалённом хосте, то необходимо дополнить её имя
                спецификацией удалённого сервера. Например:
                <programlisting>
gbak -b server:C:\data\my.fdb D:\backup\my.fbk ...   
</programlisting>
                или <programlisting>
gbak -b server:mydb D:\backup\my.fbk ...   
</programlisting>
            </para>
            <para>Спецификацию удалённого хоста удобно указывать с помощью URL-подобного синтаксиса,
                в котором можно явно задать используемый протокол:
                <programlisting>
gbak -b inet://localhost:3053/mydb D:\backup\my.fbk ...   

gbak -b wnet:///mydb D:\backup\my.fbk ...   
</programlisting>
            </para>

            <important>
                <para>При использовании диспетчера служб (переключатель <code>-SE</code>) перед
                    именем базы данных не нужно указывать спецификацию удалённого сервера, поскольку
                    в этом случае она указывается перед именем диспетчера служб.</para>
            </important>
        </section>


        <section>
            <title>Имя файла(ов) резервной копии</title>

            <para>Сразу после имени базы данных необходимо указать полный путь до файла резервной
                копии. Если для создания резервной копи не используется диспетчер служб
                (переключатель <code>-SE</code>), то резервная копия будет создана на локальной
                машине, с которой запущен gbak. При использовании диспетчера служб резервная копия
                будет создана на удалённом компьютере, на котором расположена база данных.</para>

            <para>Имя файла резервной копии может любое расширение. Вы можете встретить
                    <filename>bak</filename>, <filename>gbk</filename>, <filename>fbk</filename>, и
                так далее. Никаких ограничений в этом плане не накладывается. Имя резервной копии
                лучше формировать как имя базы и дату, причем дату лучше всего указывать в
                    <quote>японском</quote> формате, в виде YYYYMMDD – так имена файлов будут
                корректно сортироваться при просмотре папки.</para>

            <para>Существует возможность делать многофайловую резервную копию, разбивая резервную
                копию на части. В этом случае указывается несколько файлов резервных копий. После
                каждого файла резервной копии, кроме самого последнего, необходимо указать его
                максимальный размер. По умолчанию размер указывается в байтах. Вы можете также
                указывать размер в килобайтах, мегабайтах и гигабайтах, используя множители (k, m
                или g). </para>

            <example>
                <title>Создание многофайловой копии</title>
                <para>В примере ниже будут созданы три файла резервной копии, два файла размером по
                    100 Мегабайт, и третий файл в котором расположена оставшаяся часть резервной
                    копии.</para>
                <para>
                    <programlisting>
gbak -b C:\data\my.fdb D:\backup\copy_1.fbk 100M D:\backup\copy_2.fbk 100M 
  D:\backup\copy_3.fbk -user SYSDBA -password masterkey  
</programlisting>
                </para>
            </example>
        </section>

        <section>
            <title>Ускорение резервного копирования</title>

            <para>Есть несколько приемов, которые вы можете использовать для ускорения резервного
                копирования. Первый — запретить сборку мусора во время выполнения резервного
                копирования. Сборка мусора удаляет старые версии записей, которые больше не
                требуются, и это обычно покрывается чисткой (sweep) — ручной или автоматической —
                или полным сканированием таблицы любой затронутой таблицы. Поскольку gbak получает
                доступ ко всем строкам в резервируемых таблицах, он также запускает сборку мусора,
                что может замедлить резервное копирование. Чтобы предотвратить сборку мусора во
                время резервного копирования, используйте параметр <code>-g[arbage_collect]</code>.
                <synopsis>
gbak -backup -g employee /backups/employee.fbk                
            </synopsis>
            </para>

            <para>Второй вариант — делать резервное копирование с использованием диспетчера служб,
                т.е. задействовать опцию <code>-se[rvice]</code>. </para>
            <para>В обычном режиме при создании резервной копии gbak самостоятельно читает с сервера
                метаданные и данные из записывает их в файл резервной копии. При использовании
                диспетчера служб gbak только даёт команду начать резервную копию или восстановление
                серверу, и он сам делает это. Однако gbak может принимать лог действий от сервера,
                который будет вестись при указании ключа <code>-v[erify]</code>. В этом случае при
                создании резервной копии файлы копии будут создаваться на сервере. Для возможности
                восстановления базы данных файлы резервной копии так же должны находится на
                сервере.</para>
            <para>Поскольку при использовании диспетчера служб резервную копию выполняет сам сервер,
                то это позволяет избежать копирования данных по сети, за исключением лога действий,
                если он включен. Это в свою очередь позволяет делать резервную копию гораздо
                быстрее, даже на локальном компьютере.</para>
            <para>Примеры резервного копирования с использованием диспетчера служб:
                <synopsis>
gbak -backup -service tux:service_mgr employee /backups/employee.fbk   

gbak -backup -service inet4://tux:3051/service_mgr employee /backups/employee.fbk   
            </synopsis>
            </para>

            <para>Для достижения лучшего результата вы можете комбинировать опции
                    <code>-g[arbage_collect]</code> и <code>-se[rvice]</code>.</para>
        </section>

        <section>
            <title>Примеры команд резервного копирования</title>

            <example>
                <title>Создание резервной копии на локальном компьютере</title>

                <para>Следующая команда создаёт резервную копию на локальном компьютере (gbak и
                    сервер базы данных находятся на одном и том же компьютере).
                    <synopsis>
gbak -b -g d:\data\employee.fdb d:\backups\employee.fbk -user sysdba
-password masterkey
            </synopsis>
                </para>
                <para>Обратите внимание на опцию <code>-g</code> которая указана для отключения
                    сборки мусора, чтобы ускорить процесс резервного копирования.</para>
                <para>В данном случае будет использован локальный протолок для доступа к базе
                    данных. Вы можете явно указать локальный протокол при помощи префикса xnet.
                    Вместо пути к первичному файлу базы данных используется алиас.
                    <synopsis>
gbak -b -g xnet://employee d:\backups\employee.fbk -user sysdba -pas masterkey
            </synopsis>
                </para>
                <para>Для более быстрого создания резервной копии на локальном компьютере
                    рекомендуем использовать диспетчер служб.
                    <synopsis>
gbak -b -g -se service_mgr employee d:\backups\employee.fbk 
-user sysdba -pas masterkey
            </synopsis>
                </para>
            </example>

            <example>
                <title>Создание резервной копии на удалённом компьютере</title>

                <para>Следующая команда создаёт резервную копию на удалённом компьютере (gbak и
                    сервер базы данных находятся на разных компьютерах). Используется протокол TCP.
                    Резервная копия будет создана на компьютере на котором запущен gbak.
                    <synopsis>
gbak -b -g remotehost:d:\data\employee.fdb d:\backups\employee.fbk -user sysdba
-password masterkey
            </synopsis>
                    Если Firebird работает на нестандартном порту, например 3051, то команда
                    измениться так:
                    <synopsis>
gbak -b -g remotehost/3051:d:\data\employee.fdb d:\backups\employee.fbk -user sysdba
-password masterkey
            </synopsis>
                </para>
                <para>Вы можете явно указать протокол TCP при помощи префиксов: inet, inet4, inet6.
                    Вместо пути к первичному файлу базы данных используется алиас.
                    <synopsis>
gbak -b -g inet://remotehost/employee d:\backups\employee.fbk 
-user sysdba -pas masterkey
            </synopsis>
                    Если Firebird работает на нестандартном порту, например 3051, то команда
                    измениться так:
                    <synopsis>
gbak -b -g inet://remotehost:3051/employee d:\backups\employee.fbk 
-user sysdba -pas masterkey
            </synopsis>
                </para>

                <para>Для более быстрого создания резервной копии рекомендуем использовать диспетчер
                    служб. Однако учтите, что в этом случае резервная копия будет создана на том же
                    компьютере, на котором расположена база данных.
                    <synopsis>
gbak -b -g -se remotehost:service_mgr employee d:\backups\employee.fbk 
-user sysdba -pas masterkey
            </synopsis>
                </para>

                <para>Вариант с использованием явного указания префикса протокола представлен ниже:
                    <synopsis>
gbak -b -g -se inet4://remotehost/service_mgr employee d:\backups\employee.fbk 
-user sysdba -pas masterkey
            </synopsis>
                </para>

                <para>Существует возможность создания резервной копии на удалённом компьютере с
                    использованием диспетчера служб, однако утилита gbak её не предоставляет. Однако
                    вы можете воспользоваться утилитой fbsvcmgr. Пример использования вы можете
                    найти в разделе <link xmlns:xlink="http://www.w3.org/1999/xlink"
                        linkend="fbsvcmgr-gbak-backup">Утилита FBSVCMGR. Резервная копия
                        (gbak)</link>.</para>
            </example>
            <example>
                <title>Создание резервной копии с логом операций gbak</title>

                <para>Следующая команда создаст резервную копию на локальном компьютере с
                    использование диспетчера служб. Журнал операций выполняем gbak будет выведен на
                    консоль.
                    <synopsis>
gbak -b -g -se inet://localhost/service_mgr -user sysdba -password masterkey 
employee /copy/employee.dmp -v
            </synopsis>
                </para>

                <para>Каждую операцию можно снабдить статистикой с помощью опции <code>-ST</code>.
                    <synopsis>
gbak -b -g -se inet://localhost/service_mgr -user sysdba -password masterkey 
employee /copy/employee.dmp -v -st trwd
            </synopsis>
                </para>

                <para>Для того чтобы журнал операций gbak был записан в файл добавим опцию
                        <code>-Y</code>.
                    <synopsis>
gbak -b -g -se inet://localhost/service_mgr -user sysdba -password masterkey 
employee /copy/employee.dmp -v -st trwd -y /copy/employee_dump.log
            </synopsis>
                </para>
            </example>
            <example>
                <title>Создание резервной копии только метаданных</title>

                <para>Следующая команда создаст резервную копию на локальном компьютере с
                    использование диспетчера служб. В резервную копию попадут только метаданные (
                    описания таблиц, представлений, хранимых, процедур и функций, триггеров, но без
                    данных в таблицах).
                    <synopsis>
gbak -b -g -metadata -se inet://localhost/service_mgr -user sysdba -password masterkey 
employee /copy/employee.dmp
            </synopsis>
                </para>
            </example>
            <example>
                <title>Создание резервной копии с исключением данных некоторых таблиц</title>

                <para>Иногда требуется создать резервную копию, но исключить из неё данные некоторых
                    таблиц, чтобы уменьшить объём резервной копии. Например, это могут быть таблицы
                    логирования, которые могут содержать довольно значительный объём данных, но
                    хранение которых не критично. Учтите, что от данных исключаемой таблицы не
                    должно быть зависимостей, т.е. ссылок на её строки из других по внешнему ключу.
                    Если таковые имеются, то их следует также исключить из резервной копии, в
                    противном случае из-за нарушения ограничений целостности. база данных не может
                    быть восстановлена.</para>
                <para>В следующей команде будет создана резервная копия из которой будут исключены
                    данные таблиц table1 и table2. Для исключения данных таблиц из резервной копии
                    используется переключатель <code>-SKIP_D[ATA]
                            <replaceable>&lt;pattern&gt;</replaceable></code>, где
                        <replaceable>&lt;pattern&gt;</replaceable> — регулярное выражение в
                    SQL-синтаксисе (см. оператор SIMILAR TO). Из резервной копии будут исключены
                    таблицы соответствующие регулярному выражению. Если вам необходимо исключить
                    конкретный список таблиц, вы можете перечислить их имена, разделив их символом
                        <quote>|</quote>.
                    <synopsis>
gbak -b -g -se inet://localhost/service_mgr -user sysdba -password masterkey 
-skip_data table1|table2 employee /copy/employee.dmp
            </synopsis>
                </para>
            </example>
            <example>
                <title>Создание многофайловой резервной копии</title>

                <para>В примере ниже будут созданы три файла резервной копии, два файла размером по
                    100 Мегабайт, и третий файл в котором расположена оставшаяся часть резервной
                    копии.</para>
                <para>
                    <programlisting>
gbak -b -g inet://localhost/service_mgr -user SYSDBA -password masterkey
C:\data\my.fdb D:\backup\copy_1.fbk 100M D:\backup\copy_2.fbk 100M D:\backup\copy_3.fbk
</programlisting>
                </para>
            </example>
        </section>
    </section>
    <section>
        <title>Восстановление базы данных из резервной копии</title>

        <para>Процесс восстановления базы данных из резервной копии происходит следующим образом: <orderedlist>
                <listitem>
                    <para>Сервер создает пустую базу данных. Причем, создает ее в том формате баз
                        данных (ODS), который является для него <quote>родным</quote>. Пустая база
                        данных будет содержать все системные таблицы rdb$ (пока пустые), и будет
                        иметь ряд параметров, например, такие как размер страницы, forced write и т.
                        д., которые или взяты из резервной копии, или установлены в командной строке
                        gbak.</para>
                </listitem>
                <listitem>
                    <para>Сервер считывает метаданные (описания таблиц и индексов, процедур,
                        функций) из резервной копии и переносит их в базу данных.</para>
                </listitem>
                <listitem>
                    <para>Сервер считывает данные из резервной копии и переносит их в базу
                        данных</para>
                </listitem>
                <listitem>
                    <para>Сервер считывает остальные метаданные (триггеры, привилегии, check
                        constraints и т. п.) из резервной копии и переносит их в базу данных</para>
                </listitem>
                <listitem>
                    <para>Сервер создает (активирует) все индексы таблиц (которые были активны в
                        момент создания резервной копии)</para>
                </listitem>
            </orderedlist></para>

        <note>
            <para>Если вас интересует точная последовательность действий gbak при backup и restore,
                например, порядок сохранения и восстановления объектов метаданных, то вы можете
                обратиться к исходным текстам — <filename>backup.epp</filename> и
                    <filename>restore.epp</filename> соответственно. По мере развития IB/FB и
                исправления ошибок порядок сохранения-восстановления некоторых объектов
                изменялся.</para>
        </note>

        <para>Таким образом, восстановленная из резервной копии база данных будет на самом деле не
            копией старой базы, а совершенно новой базой данных, наполненной старыми данными.</para>

        <para>Помните, что если вы делаете восстановление на новой версии сервера, например,
            резервную копию делали на Firebird 2.5 (формат БД ODS 11.3), а восстанавливаете на
            Firebird 3.0 (формат БД ODS 12.0), то база будет создана в формате, поддерживаемом по
            умолчанию Firebird 3.0, и Firebird 2.5 с этой базой работать не сможет.</para>

        <para>Резервные копии тоже имеют свой формат, и резервная копия БД, сделанная например в
            Firebird 2.5 утилитой gbak этой же версии, не может быть восстановлена утилитой gbak от
            Firebird 2.1. Резервная копия сделанная в Firebird 3.0 моет быть восстановлена в
            Firebird 2.5, при условии, что база данных не использует новые возможности ODS 12
            (хранимые функции, пакеты, новые типы данных, новые возможности SQL и PSQL в метаданных
            и другое).</para>

        <para>Для восстановления базы данных пользователь должен обладать административной
            привилегией в базе данных безопасности (SYSDBA или соединиться с ролью RDB$ADMIN) или
            обладать привилегией <code>CREATE DATABASE</code>. Этот пользователь будет владельцем
            восстановленной базы данных.</para>

        <para>Формат командной строки для восстановления базы данных из резервной копии выглядит
            следующим образом:
            <programlisting>
gbak {-c | -r o | -rep} <replaceable>&lt;backup set&gt;</replaceable> <replaceable>&lt;db set&gt;</replaceable> [<replaceable>restore options</replaceable>] [<replaceable>general options</replaceable>]                
                 
<replaceable>&lt;backup set&gt;</replaceable> ::= <replaceable>backup_file</replaceable> [<replaceable>backup_file_2</replaceable> ... [<replaceable>backup_file_N</replaceable>]]  

<replaceable>&lt;db set&gt;</replaceable> ::= <replaceable>&lt;database&gt;</replaceable> [<replaceable>size1</replaceable> <replaceable>db2</replaceable> ... [<replaceable>sizeN-1</replaceable> <replaceable>dbN</replaceable>]]             

<replaceable>&lt;database&gt;</replaceable> ::= [<replaceable>&lt;server_spec&gt;</replaceable>]{<replaceable>filepath</replaceable> | <replaceable>db_alias</replaceable>}     

<replaceable>&lt;server_spec&gt;</replaceable> ::= 
    <replaceable>hostname</replaceable>[\<replaceable>port</replaceable> | <replaceable>service</replaceable>]: 
  | \\<replaceable>hostname</replaceable>[@<replaceable>port</replaceable> | <replaceable>service</replaceable>]\ 
  | <replaceable>&lt;protocol&gt;</replaceable>://[<replaceable>hostname</replaceable>[:<replaceable>port</replaceable> | <replaceable>service</replaceable>]/]

<replaceable>&lt;protocol&gt;</replaceable> = inet | inet4 | inet6 | wnet | xnet
            </programlisting>
        </para>

        <section>
            <title>Создание базы данных, восстановление или замена</title>

            <para>Восстановление базы данных из резервной копии может происходить в нескольких
                режимах. <itemizedlist>
                    <listitem>
                        <para><code>-C[REATE_DATABASE]</code> — создание новой базы данных из
                            резервной копии. Если файл базы данных уже существует, то будет выдана
                            ошибка.</para>
                    </listitem>
                    <listitem>
                        <para><code>-R[ECREATE_DATABASE] [O[VERWRITE]]</code> — создание новой (или
                            замена существующей при использовании опции <code>O[VERWRITE]</code>)
                            базы данных из резервной копии. Если базы данных не существует, то будет
                            создана новая база данных. Если база данных уже существует, то при
                            использовании опции <code>O[VERWRITE]</code> она будет заменена на
                            новую, в противном случае будет выдана ошибка.</para>
                    </listitem>
                    <listitem>
                        <para><code>-REP[LACE_DATABASE]</code> — замена существующей базы данных при
                            восстановлении из резервной копии.</para>
                    </listitem>
                </itemizedlist></para>

            <note>
                <para>Настоятельно рекомендуем не пользоваться ключами <code>-R O</code> и
                        <code>-REP</code>. Если база данных существует на диске, и вы просите gbak
                    восстановить ее с помощью одного из двух указанных выше ключей, вы можете
                    повредить базу данных, особенно если база данных используется и не была закрыта
                    с помощью gfix. </para>

                <para>Кроме того, процесс восстановления базы данных из резервной копии может
                    завершиться неудачей, и в этом случае вы окажетесь без рабочей базы
                    данных.</para>

                <para>В целях безопасности всегда заново создавайте базу данных с новым именем.
                    Только после того как вы проверили целостность новой базы данных, вы можете
                    заменить ею рабочую базу данных.</para>
            </note>
        </section>

        <section>
            <title>Опции восстановления базы данных из резервной копии</title>

            <table frame="topbot">
                <title>Опции восстановления базы данных из резервной копии с помощью GBAK</title>
                <tgroup cols="2">
                    <colspec colname="c1" colnum="1" colwidth="0.75*" align="left"/>
                    <colspec colname="c2" colnum="2" colwidth="1.25*" align="left"/>
                    <thead>
                        <row>
                            <entry>Опция</entry>
                            <entry>Описание</entry>
                        </row>
                    </thead>
                    <tbody>
                        <row>
                            <entry><code>-C[REATE_DATABASE]</code></entry>
                            <entry>
                                <para>Создание новой базы данных из резервной копии. Если файл базы
                                    данных уже существует, то будет выдана ошибка.</para></entry>
                        </row>
                        <row>
                            <entry><code>-R[ECREATE_DATABASE] [O[VERWRITE]]</code></entry>
                            <entry>
                                <para>Создание новой (или замена существующей при использовании
                                    опции <code>O[VERWRITE]</code>) базы данных из резервной копии.
                                    Если базы данных не существует, то будет создана новая база
                                    данных. Если база данных уже существует, то при использовании
                                    опции <code>O[VERWRITE]</code> она будет заменена на новую, в
                                    противном случае будет выдана ошибка.</para>
                            </entry>
                        </row>
                        <row>
                            <entry><code>-REP[LACE_DATABASE]</code></entry>
                            <entry><para>Замена существующей базы данных при восстановлении из
                                    резервной копии.</para></entry>
                        </row>
                        <row>
                            <entry><code>-BU[FFERS]
                                <replaceable>&lt;n&gt;</replaceable></code></entry>
                            <entry><para>Изменить (или указать новый) размер страничного кэша базы
                                    данных. Принимается значение больше 0. Размер кэша базы данных
                                    прописывается в её заголовок, его можно изменить позже с помощью
                                    утилиты gfix. Рекомендуем не устанавливать кэш на уровне
                                    заголовка базы данных, а использовать вместо этого параметр
                                        <parameter>DefaultDbCachePages</parameter> в файле
                                        <filename>databases.conf</filename>.</para></entry>
                        </row>
                        <row>
                            <entry><code>-FIX_FSS_D[ATA]
                                    <replaceable>&lt;charset&gt;</replaceable></code></entry>
                            <entry><para>Этот переключатель заставляет gbak исправлять искаженные
                                    символьные данные UNICODE_FSS во время восстановления.</para>
                                <para>Этот и следующий переключатель не требуется при нормальных
                                    обстоятельствах. Однако, если операция восстановления
                                    завершается неудачно с ошибкой <quote>malformed string</quote>,
                                    то сообщение, выведенное из gbak, отсылает пользователя к одному
                                    или обоим этим переключателям для исправления неверно
                                    сформированных данных или метаданных UNICODE_FSS в зависимости
                                    от ситуации.</para></entry>
                        </row>
                        <row>
                            <entry><code>-FIX_FSS_M[ETADATA]
                                        <replaceable>&lt;charset&gt;</replaceable></code></entry>
                            <entry><para>Этот переключатель заставляет gbak исправлять некорректные
                                    метаданные UNICODE_FSS во время восстановления.</para>
                                <para>Этот переключатель, как и предыдущий, не требуется в
                                    нормальных условиях. Однако, если операция восстановления
                                    завершается неудачно с ошибкой <quote>malformed string</quote>,
                                    сообщение, выведенное из gbak, отсылает пользователя к одному
                                    или обоим этим переключателям для исправления неверно
                                    сформированных данных или метаданных UNICODE_FSS в зависимости
                                    от ситуации.</para></entry>
                        </row>
                        <row>
                            <entry><code>-I[NACTIVE]</code></entry>
                            <entry><para>Не выполнять активацию индексов. После восстановления базы
                                    данных все индексы в ней останутся отключены (неактивны).
                                    Фактически с такой базой данных работать нельзя, т. к. при
                                    отключенных индексах Primary key, Foreign key и Unique возможны
                                    нарушения целостности данных в таблицах (дублирование первичных
                                    ключей и т. д.).</para>
                                <para>Если вы восстановили резервную копию с опцией <code>-i</code>,
                                    индексы можно активировать командой <code>alter index
                                            <replaceable>indexname</replaceable> active</code> (для
                                    каждого индекса).</para></entry>
                        </row>
                        <row>
                            <entry><code>-K[ILL]</code></entry>
                            <entry><para>Этот ключ восстанавливает базу данных, но не воссоздает
                                    файлы теневых копий, которые существовали ранее.</para></entry>
                        </row>
                        <row>
                            <entry>
                                <code>-MO[DE] {read_write | read_only}</code>
                            </entry>
                            <entry><para>Этот переключатель позволяет восстановить базу данных в
                                    заданном режиме доступа <quote>read_only</quote> или
                                        <quote>read_write</quote>. По умолчанию режим берется из
                                    базы данных, с которой была сделана резервная
                                копия.</para></entry>
                        </row>
                        <row>
                            <entry><code>-N[O_VALIDITY]</code></entry>
                            <entry><para>Не выполнять проверку ограничений. Может потребоваться.
                                    если при обычном восстановлении базы оказалось, что логическая
                                    целостность оригинальной базы данных была повреждена.</para>
                                <para>Крайне не рекомендуется для использования в <quote>командной
                                        строке автоматизированного
                                восстановления</quote>.</para></entry>
                        </row>
                        <row>
                            <entry><code>-O[NE_AT_A_TIME]</code></entry>
                            <entry><para>Этот переключатель заставляет восстанавливать одну таблицу
                                    за раз. Обычно восстановление данных таблиц выполняется в одной
                                    транзакции с одним подтверждением в конце восстановления. При
                                    использовании опции <code>-o[ne_at_a_time]</code> транзакция
                                    стартует и фиксируется для восстановления каждой таблицы.</para>
                                <para>Эта опция может быть полезна, если предыдущее восстановление
                                    не удалось из-за ошибок данных. </para></entry>
                        </row>
                        <row>
                            <entry><code>-P[AGE_SIZE]
                                <replaceable>&lt;n&gt;</replaceable></code></entry>
                            <entry><para>Указать новый размер страницы для базы данных. Принимаются
                                    значения: 4096, 8192, 16384. По умолчанию база данных
                                    восстанавливается с использованием того же размера страницы,
                                    который использовался при создании резервной базы
                                данных.</para></entry>
                        </row>
                        <row>
                            <entry><code>-USE_[ALL_SPACE]</code></entry>
                            <entry><para>Этот переключатель заставляет при восстановлении
                                    использовать 100% каждой страницы данных (DP). По умолчанию
                                    Firebird резервирует приблизительно 20% на каждой странице для
                                    размещения версий при будущих удалениях или обновлениях записей.
                                    Этот переключатель может быть полезен если база данных создается
                                    и используется в режиме только для чтения, а обновления
                                    существующих данных не требуются.</para>
                                <para>Вы можете переопределить этот параметр, используя <code>gfix
                                        -use {full | reserve}
                                            <replaceable>database_name</replaceable></code>, где
                                    full использует 100% каждой страницы, а reserve зарезервирует
                                    некоторое место для версий. Подробнее смотри в главе
                                        <quote>Утилита GFIX</quote> секции <link
                                        xlink:href="gfix-use_space">Использование пространства
                                        страниц базы данных</link>.</para></entry>
                        </row>
                    </tbody>
                </tgroup>
            </table>
        </section>
        <section>
            <title>Имя файла(ов) резервной копии</title>

            <para>Необходимо указывать полный путь до файла резервной копии. Если при восстановлении
                базы данных не используется диспетчер служб (переключатель <code>-SE</code>), то
                файл резервной копии будет прочитан с локальной машины, на которой расположен
                    <application>gbak</application>. При использовании диспетчера служб, файл
                резервной копии будет прочитан с машины, на которой расположен Firebird (хост указан
                в спецификации диспетчера служб).</para>
            <para>Вы можете восстанавливать базу данных из многофайловой резервной копии. В этом
                случае файлы резервной копии должны быть разделены пробелами.</para>

            <example>
                <title>Восстановление из многофайловой копии</title>
                <para>В примере восстановлена база данных из многофайловой реервной копии</para>
                <para>
                    <programlisting>
gbak -c -se inet://localhost/service_mgr -user sysdba -password masterkey 
  d:\copy\db1.fbk d:\copy\db.fbk d:\copy\db3.fbk d:\data\db.fdb
</programlisting>
                </para>
            </example>
        </section>
        <section>
            <title>Имя файла(ов) базы данных</title>

            <para>Если база данных распложено локально, то достаточно просто указать путь к
                первичному файлу базы данных или её псевдоним. Например:
                <programlisting>
gbak -c d:\copy\db.fbk d:\data\db.fdb
</programlisting>
            </para>

            <para> или с использованием алиаса
                <programlisting>
gbak -c d:\copy\db.fbk db
</programlisting>
            </para>

            <para>Если же база данных расположено на удалённом хосте, то необходимо дополнить её имя
                спецификацией удалённого сервера. Например:
                <programlisting>
gbak -c d:\copy\db.fbk remotehost:d:\data\db.fdb
</programlisting>
            </para>

            <para>Спецификацию удалённого хоста удобно указывать с помощью URL-подобного синтаксиса,
                в котором можно явно задать используемый протокол:
                <programlisting>
gbak -c d:\copy\db.fbk inet://remotehost:3053/d:\data\db.fdb

gbak -c d:\copy\db.fbk xnet://d:\data\db.fdb
</programlisting>
            </para>

            <important>
                <para>При использовании диспетчера служб (переключатель <code>-SE</code>) перед
                    именем базы данных не нужно указывать спецификацию удалённого сервера, поскольку
                    в этом случае она указывается перед именем диспетчера служб.</para>
            </important>

            <para>Существует возможность восстанавливать многофайловую базу данных из резервной
                копию. В этом случае указывается несколько файлов базы данных. После каждого файла
                базы данных, кроме самого последнего, необходимо указать его максимальный размер в
                страницах. Например:
                <programlisting>
gbak -c -se inet://localhost/service_mgr -user sysdba -password masterkey 
  d:\copy\db.fbk  d:\data\db.fdb 50000 d:\data\db.fdb
</programlisting>
            </para>

            <para>Кроме того. существует возможность восстановления многофайловой базы данных из
                многофайловой резервной копии. В этом случае утилита gbak сама определит где
                заканчивается перечисление файлов резервной копии и начинается перечисление файлов
                баз данных. Либо файл базы данных указан последним, либо после файла базы данных
                указан размер в страницах. Пример:
                <programlisting>
gbak -c -se inet://localhost/service_mgr -user sysdba -password masterkey 
  d:\copy\db_1.fbk d:\copy\db_2.fbk d:\copy\db_3.fbk d:\data\db.fdb 50000 d:\data\db.fdb
</programlisting>
            </para>
        </section>
        <section>
            <title>Ошибки искажения строк во время процесса восстановления</title>

            <para>Во время операции восстановления, скорее всего, при восстановлении резервной
                копии, созданной с использованием более старой версии
                    <application>gbak</application>, в выводе <application>gbak</application> можно
                увидеть сообщения об ошибках, указывающие на искаженные Unicode строки. Причина, по
                которой это может произойти, объясняется Хелен Борри:</para>

            <blockquote>
                <para>Исходный текст хранимых процедур (и некоторых других типов объектов, таких как
                    ограничения CHECK) хранится в BLOB поле, как и <quote>скомпилированный</quote>
                    код BLR. При восстановлении базы данных BLR не воссоздается из исходного когда:
                    этот же BLR используется до тех пор, пока вы в следующий раз не создадите или не
                    измените объект метаданных.</para>

                <para>Исторически Firebird не делал правильных вещей в отношении транслитерации
                    строк с исходным кодом и BLR. В Firebird 2.1 и Firebird 2.5 была проделана
                    большая работа для решения международных языковых проблем. Побочным эффектом
                    этого было то, что все, что было прочитано из данных и метаданных, стало
                    предметом проверки <quote>правильности</quote>. Следовательно, при
                    восстановлении, те ранее сохраненные исходные коды объектов и BLR выдают ошибки
                        <quote>malformed string</quote>, когда <application>gbak</application>
                    пытается прочитать и записать данные в этих записях системной таблицы. Эта очень
                    старая ошибка также влияет на пользовательские BLOB, если они были сохранены с
                    использованием набора символов NONE, а клиент настроен на чтение указанного
                    набора символов, для которого сохраненные данные не могут быть
                    транслитерированы.</para>

                <para>В версии 2.1 в <filename>../misc</filename> были сценарии, которые вы могли
                    запускать для восстановления BLOB метаданных, а также использовать в качестве
                    шаблона для исправления подобных ошибок в BLOB ваших пользовательских данных.
                    Ключи восстановления были добавлены в код восстановления
                        <application>gbak</application> в версии 2.5 для внесения таких же
                    исправлений в метаданные (опция <code>-fix_fss_m[etadata]</code>) и данные
                    (опция <code>-fix_fss_d[ata]</code>), соответственно, в процессе восстановления
                    базы данных для обновления.</para>
            </blockquote>

            <warning>
                <para>Обе опции <code>-fix_fss_*</code> указываются ОДИН раз в том случае, если при
                    восстановлении бэкапа возникает ошибка <quote>malformed string</quote>. При
                    указании этих опций повторно при backup/restore база данных будет
                    испорчена.</para>
            </warning>
        </section>
        <section>
            <title>Ускорение восстановления базы данных</title>

            <para>Восстановление базы данных из резервной копии может быть выполнено быстрее, если
                используется опция <code>-se[rvice]</code>. Чаще всего эта опция используется для
                удаленного восстановления, но она также может использоваться локально. Данная опция
                позволяет избежать копирования данных по сети TCP, что замедляет действия по
                восстановлению.
                <programlisting>
tux> gbak -replace -service tux:service_mgr /backups/employee.fbk employee                
            </programlisting>
            </para>
        </section>
        <section>
            <title>Примеры команд восстановления из резервной копии</title>

            <example>
                <title>Восстановление из резервной копии на локальном компьютере</title>

                <para>Следующая команда восстановит (создаст новую базу данных) из резервной копии
                    на локальном компьютере (gbak и сервер базы данных находятся на одном и том же
                    компьютере).
                    <synopsis>
gbak -с d:\backups\employee.fbk d:\data\employee.fdb -user sysdba
-password masterkey
            </synopsis>
                </para>

                <important>
                    <para>Обратите внимание, если файл базы данных уже существует, то будет выдана
                        ошибка.</para>
                    <para>Существуют так же опции <code>-r o</code> (<code>-RECREATE_DATABASE
                            OVERWRITE</code>) или <code>-rep</code>
                        (<code>-REPLACE_DATABASE</code>), которые позволяют заменить существующий
                        файл базы данных, однако мы не рекомендуем использовать их, поскольку они
                        могут привести к утрате оригинального файла базы данных в случае если
                        восстановление завершиться с ошибкой.</para>
                </important>

                <para>В примере выше будет использован локальный протолок. Вы можете явно указать
                    локальный протокол при помощи префикса xnet.
                    <synopsis>
gbak -с d:\backups\employee.fbk xnet://d:\data\employee.fdb -user sysdba
-password masterkey
            </synopsis>
                </para>

                <para>Для более быстрого восстановления базы данных из резервной копии на локальном
                    компьютере рекомендуем использовать диспетчер служб.
                    <synopsis>
gbak -с -se service_mgr d:\backups\employee.fbk d:\data\employee.fdb -user sysdba
-password masterkey
            </synopsis>
                </para>
            </example>
            <example>
                <title>Восстановление из резервной копии на удалённом компьютере</title>

                <para>Следующая команда восстанавливает базу данных (создаёт новую) из резервной
                    копии расположенной на удалённом компьютере (gbak и сервер базы данных находятся
                    на разных компьютерах). Используется протокол TCP. База данных будет создана на
                    компьютере на котором расположен сервер Firebird.
                    <synopsis>
gbak -с d:\backups\employee.fbk remotehost:d:\data\employee.fdb -user sysdba
-password masterkey
            </synopsis>
                </para>
                <para>Если Firebird работает на нестандартном порту, например 3051, то команда
                    измениться так:
                    <synopsis>
gbak -с d:\backups\employee.fbk remotehost/3051:d:\data\employee.fdb -user sysdba
-password masterkey
            </synopsis>
                </para>
                <para>Вы можете явно указать протокол TCP при помощи префиксов: inet, inet4, inet6.
                    Вместо пути к первичному файлу базы данных используется алиас.
                    <synopsis>
gbak -с d:\backups\employee.fbk inet://remotehost/employee -user sysdba
-password masterkey
            </synopsis>
                </para>
                <para>Если Firebird работает на нестандартном порту, например 3051, то команда
                    измениться так:
                    <synopsis>
gbak -с d:\backups\employee.fbk inet://remotehost:3051/employee -user sysdba
-password masterkey
            </synopsis>
                </para>
                <para>Для более быстрого восстановления базы данных из резервной копии рекомендуем
                    использовать диспетчер служб. Однако учтите, что в этом случае резервная копия
                    должна быть распложена на том же компьютере, на котором расположен сервер
                    Firebird.
                    <synopsis>
gbak -с -se remotehost:service_mgr d:\backups\employee.fbk d:\data\employee.fdb -user sysdba
-password masterkey
            </synopsis>
                </para>
                <para>Вариант с использованием явного указания префикса протокола представлен ниже:
                    <synopsis>
gbak -с -se inet://remotehost/service_mgr d:\backups\employee.fbk d:\data\employee.fdb -user sysdba
-password masterkey
            </synopsis>
                </para>
                <para>Существует возможность восстановления из удалённой резервной копии с
                    использованием диспетчера служб, однако утилита gbak её не предоставляет. Однако
                    вы можете воспользоваться утилитой fbsvcmgr. Пример использования вы можете
                    найти в разделе <link xmlns:xlink="http://www.w3.org/1999/xlink"
                        linkend="fbsvcmgr-gbak-restore">Утилита FBSVCMGR. Восстановление
                        (gbak)</link>.</para>
            </example>
        </section>
    </section>
</chapter>
